<script type="text/javascript">
   /* Locks  */

   function setup_key_change_links(){
        $('.host_key_change').live('click', function(e) {
            e.preventDefault(); 
            $('.host_key').val($(this).attr('href'));
            window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));
        });
        $('.file_key_change').live('click', function(e) {
            e.preventDefault(); 
            if($('.host_key').val() != ""){
                $('.file_key').val($(this).attr('href'));
                window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));
            }else{
                alert("You must specify a host first!");
            }
        });
   } 
   function get_todays_date_key(){
        var today = new Date();
        var cur_date = String(today.getFullYear()) + String(today.getMonth() +1) + String(today.getDate());
        return cur_date;
    }
    function transform_date_to_date_key(date){
        var today = new Date();
        var date_key = String(today.getFullYear()) + String(today.getMonth() +1) + String(today.getDate());
        return date_key;
    }
    function get_date_key_for(days_ago, hours_ago){
        var d = new Date();
        d.setHours(d.getHours() + 1 - hours_ago);
        d.setDate(d.getDate() - days_ago); 
        var date_key = String(d.getFullYear()) + String(d.getMonth() +1) + String(d.getDate());
        return [date_key, d.getHours()];
    }

    function gup( name ){
        /*  To use this, see the following */
        /* http://www.foo.com/index.html?bob=123&frank=321&tom=213#top */
        /* var frank_param = gup( 'frank' ); */
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( window.location.href );
        if( results == null ){
            return "";
        }else{
            return results[1];
        }
    }
    function get_page_name(){
        pathArray = window.location.pathname.split( '/' );
        return pathArray[pathArray.length - 1 ];
    }

    var args = ['key', 'keys', 'startkey', 'endkey', 'limit',
    'descending','skip', 'group', 'reduce', 'autoupdate']; 
    function new_setup_couchdb_url(arg_to_change, new_val_from_user){
        var arg_vals = [];
        var cur_val = "";

        for(x in args){
            if(arg_to_change == args[x]){ 
                /* this is the arg we want to change, so set it */
                if(isNaN(new_val_from_user) || new_val_from_user == ''){
                    if(new_val_from_user == "true" || new_val_from_user == "false"){
                        arg_vals[args[x]] = new_val_from_user;
                    }else{
                        if(new_val_from_user != ''){
                            arg_vals[args[x]] = "\"" + new_val_from_user + "\"";
                        } 
                    }
                }else{ 
                    arg_vals[args[x]] = new_val_from_user;    
                }
            }else{
                /* Get the current val of this arg if it exists */
                cur_val = gup(args[x]);
                if(cur_val != ""){
                    /* The old url had this arg set already, so keep it */
                    arg_vals[args[x]] = cur_val;  
                }
            }
        }

        /* Now create the url */
        var path = window.location.pathname;
        var protocol = window.location.protocol;
        var host = window.location.host;
        var url = protocol + "//" + host + path + "?";   

        for( x in arg_vals){
            url = url + x + "=" + arg_vals[x] + "&"; 
        }
        return url;
    }
    function isValidDate(input){
        var validformat=/^\d{6,8}$/
        var result = true;
        if (!validformat.test(input)){
            result = false;
        }
        return result;
    }
    function datePickersAreValid(){
        var result = true;
        var start_date = Number($('.start_key_date_picker').val());
        var end_date = Number($('.end_key_datepicker').val());
        if(start_date <= end_date){
            result = false;
            alert("The start date must come before the end date!");
        }
        return result;
    }
    function updateGuiBasedOnUrlArgs(){
        /* This is and ugly hack that I need to revist later. */
        var selected_class = 'ui_selected'; /* Class to add to UI elements that are selected */

        /* Page-base options */
        switch(get_page_name()){
            case "all":
                $(".view_all").addClass(selected_class);                
                break;
            case "warnings":
                $(".view_warnings").addClass(selected_class);                
                break;
            case "errors":
                $(".view_errors").addClass(selected_class);                
                break;
        }

        /* Get all current supported args */
        var arg_vals = [];
        var args_provided = false;
        for(x in args){
           arg_vals[args[x]] = gup(args[x]); 
           if(args_provided == false && gup(args[x]) != ""){
               args_provided = true;
           }
        }

        if(args_provided == false){
            /* If there are no options specified, force them to appear by
            clicking the link which has them specified. */
             window.location.href = $(".view_" + get_page_name()).attr('href');
        }
         
        /* Arg-specific logic  */
        if(arg_vals['autoupdate'] != ""){
            if(arg_vals['autoupdate'] == "true"){
                $(".auto_update_on").addClass(selected_class);
            }else{
                $(".auto_update_off").addClass(selected_class);
            }
        }
        if(arg_vals['limit'] != ""){
            $('.limit_options > a').each(function(i, val){
                if($(this).attr('href') == arg_vals['limit'] ){
                    $(this).addClass(selected_class);
                }
            });
        }
        if(arg_vals['descending'] != ""){
            if(arg_vals['descending'] == "false"){
               $('.ascending').addClass(selected_class); 
            }else {
               $('.descending').addClass(selected_class); 
            }
        }
        if(arg_vals['keys'] != ""){
            var keys = unescape(arg_vals['keys']);
            keys = keys.slice(1, keys.length -1);
            var keys_parsed = JSON.parse(keys);
            $('.singledatekey_datepicker').val(keys_parsed[0].date);
            $('.host_key').val(keys_parsed[0].host);
            $('.file_key').val(keys_parsed[0].file);
        }
    }
    function update_results_based_on_url_args(){
        if($('.host_key').val() != ""){
            $('.host_key_change').hide();
            $('.host_key_separator').hide();
        }
        if($('.file_key').val() != ""){
            $('.file_key_change').hide();
            $('.file_key_separator').hide();
        }

    }

function get_stringified_keys(for_transport){
    /* TODO: These should come from the url like the other args! */
    /*  Or should they... grrrr. */
    var date_key = $('.singledatekey_datepicker').val();
    var host_key = $('.host_key').val(); 
    var file_key = $('.file_key').val(); 
    var stringified_keys = "";
    var keys = [{}];

    if( isValidDate(date_key) ){
        keys[0]["date"] = date_key;
        if( host_key != null && host_key != ""){
            keys[0]["host"] = host_key;
            if( file_key != null && file_key != ""){
                keys[0]["file"] = file_key;
            }
        }
    }else{
        //console.log("Date is invalid!");
    }
    if(for_transport){
        return JSON.stringify({"keys": keys});
    }else{
        return JSON.stringify(keys);
    }
}

function update_page(){
    /* Function to read in current options and update the page's content by
    requesting a new one via AJAX request. 
    */
    update_log_volume_stats();
    // TODO: Fix this url 
    var results_url = String(window.location).replace( "index/" +
    get_page_name() + '?',"all/" + get_page_name() + "?");
    var keys = get_stringified_keys(true);
    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: results_url,
        dataType: "html",
        processData: false,
        data: keys,
        success: function(data){
            var results = $(data).filter(".results").html();
            if(results == "" || results == null){
                results = "Nothing to display...";    
            }
            $(".results").html(results);
            update_results_based_on_url_args();
            setup_key_change_links();
            /* Give a visual que that we updated the page..  */
            $('.auto_update_on').effect("pulsate", { times:3 }, 1000);
            //console.log("Updated results...");

        },error: function(XMLHttpRequest, textStatus, errorThrown){
            //console.log( "Auto update failed: " + textStatus);
        }
    });
}

function update_log_volume_stats(){
    /*  Get accumulative log volume */
    $.ajax({
        url: '{{ volume_by_day }}',
        success: function(data) {
            var x = JSON.parse(data);
            try{
                accum_bytes = x["rows"][0].value;
            }catch(err){
                accum_bytes = 0;
            }
            accum_GB = accum_bytes / 1073741824;
            accum_GB_rounded = Math.round(accum_GB*100)/100;
            $('.accum-log-volume').text("All: " + accum_GB_rounded + " GB");
        }
    });

    /* Get todays log volume  */
    var today = get_todays_date_key();
    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: '{{ volume_by_day }}' + '?group=true',
        data: JSON.stringify({"keys":[{"date":today}]}),
        success: function(data) {
            var x = JSON.parse(data);
            try{
                accum_bytes = x["rows"][0].value;
            }catch(err){
                accum_bytes = 0;
            }
            accum_bytes_rounded = Math.round(accum_bytes*100)/100;
            $('.todays-log-volume').text("Today: " + accum_bytes_rounded + " b");
        }
    });
    /* TESTING - REMOVE THIS  (START) */
    var date_keys = get_date_key_for(0, 1);
    var last_hour = transform_date_to_date_key(); 
    var date = new Date();
    /*  Note: we purposely don't correct the getHours val (starts at zero) */
    /*  BUG: This breaks when checking at one in the morning! */
    var data = JSON.stringify({"keys":[{"date":date_keys[0], "hour": date_keys[1]}]});
    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: '{{ volume_by_hour }}' + '?group=true',
        data: data,
        success: function(data){
            var x = JSON.parse(data);
            try{
                accum_bytes = x["rows"][0].value;
            }catch(err){
                accum_bytes = 0;
            }
            accum_bytes_rounded = Math.round(accum_bytes*100)/100;
            $('.last-hours-log-volume').html("Last Hour: " + accum_bytes_rounded + " b"); 
        }
    });
    /* TESTING - REMOVE THIS (END) */
}

function load_host_key_options(){
    /* Blocking because we want our GUI updater to find all of these options. */
    $.ajax({
        url: '{{ host_key_options_path }}',
        async: false,
        success: function(data){
            var test = JSON.parse(data);
            var hosts = test.rows[0].value;
            for (h in hosts){
                var new_option = "<option value=\"" + hosts[h] + "\">" + hosts[h] + "</option>";
                $('.host_key').append(new_option);
            }
        }
    });
}

function get_todays_log_volume_by_hour(hour){
    /* Hour should be an int between 1 and 24 */
    var today = get_todays_date_key(); 
    var data = JSON.stringify({"keys":[{"date":today, "hour": hour}]});
    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: '{{ volume_by_hour }}' + '?group=true',
        data: data,
        success: function(data){
            //console.log(hour+ data);
        }
    });
}
function set_activity_data(){
    /*  Testing */
    var data =  [
                {
                    label: 'Volume (bytes)',
                    data: [[0, 5], [1,20]],
                },
                {
                    label: 'Warnings',
                    data: [[1,80],[2,32]],
                },
                {
                    label: 'Errors',
                    data: [[2, 5]],
                }
            ];
    $("#graph_data").text(JSON.stringify(data));    

}

function update_activity_graph(){
    /*  Testing */
    var data = JSON.parse($("#graph_data").text());
    $.plot($(".todays_graph"), data, {});
}

    $(document).ready(function(){
        load_host_key_options();
        updateGuiBasedOnUrlArgs();
        update_page(); /* Grab our first set of results */
        if(gup('autoupdate') == "true"){
            setInterval("update_page()", 10000); /* Update the results every 10 seconds */
        }
        /* Four digit year, month and day with no leading zeros */
        $('.singledatekey_datepicker').datepicker({ 
            dateFormat: 'yymd', 
            onClose: function(dateText, inst){
                var date_key = $('.singledatekey_datepicker').val();
                if(isValidDate(date_key) ){
                    var keys = JSON.stringify([{"date": date_key}]);
                     window.location = new_setup_couchdb_url("keys", keys);  
                }
            }
        });
        $('.host_key').change(function(){
            // TODO
            window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));

        });

        $('.auto_update_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('autoupdate', $(this).attr('href'));
        });
        $('.limit_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('limit', $(this).attr('href'));
        });
        $('.descending_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('descending', $(this).attr('href'));
        });
        $('.clear_host_key').live('click', function(e) {
            e.preventDefault();
            $('.host_key').val('');
            window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));
        });
        $('.clear_file_key').live('click', function(e) {
            e.preventDefault();
            $('.file_key').val('');
            window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));
        });
        $('.clear_date_key').live('click', function(e) {
            e.preventDefault();
            cur_date = get_todays_date_key(); 
            $('.singledatekey_datepicker').val(cur_date);
            window.location = new_setup_couchdb_url("keys", get_stringified_keys(false));
        });
        $('.skip_change').live('click', function(e) {
            e.preventDefault();
            var operation = $(this).attr('href');
            var cur_skip = gup('skip');
            var cur_view_limit = gup('limit');
            var new_skip = 0;
            var big_skip = 2;

            if(cur_skip == ""){
                cur_skip = 0;
            }else{
                cur_skip = Number(cur_skip);
            }
            if(cur_view_limit == ""){
                cur_view_limit = 0;
            }else{
                cur_view_limit = Number(cur_view_limit);
            }

            if(cur_view_limit == 0){
                cur_view_limit = 25; /* Min view limit of 25 */
            }
            
            switch(operation){
                case "big_back":
                    new_skip = cur_skip - ( big_skip * cur_view_limit);
                    break;
                case "back":
                    new_skip = cur_skip - cur_view_limit;
                    break;
                case "forward":
                    new_skip = cur_view_limit + cur_skip;
                    break;
                case "big_forward":
                    new_skip = ( big_skip * cur_view_limit) + cur_skip;
                    break;
                default:
                    alert("Error in switch!");
            }
            new_skip = Math.max(0, new_skip); /* Do no give negative numbers. */
            window.location = new_setup_couchdb_url('skip', new_skip);
        });
    });
</script>
