<script type="text/javascript">
    function gup( name ){
        /*  To use this, see the following */
        /* http://www.foo.com/index.html?bob=123&frank=321&tom=213#top */
        /* var frank_param = gup( 'frank' ); */
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( window.location.href );
        if( results == null ){
            return "";
        }else{
            return results[1];
        }
    }
    var args = ['key', 'startkey', 'endkey', 'limit', 'descending','skip', 'group', 'reduce']; 
    function new_setup_couchdb_url(arg_to_change, new_val_from_user){
        var arg_vals = [];
        var cur_val = "";

        for(x in args){
            if(arg_to_change == args[x]){ 
                /* this is the arg we want to change, so set it */
                if(isNaN(new_val_from_user) || new_val_from_user == ''){
                    if(new_val_from_user == "True" || new_val_from_user == "False"){
                        arg_vals[args[x]] = new_val_from_user;
                    }else{
                        if(new_val_from_user != ''){
                            arg_vals[args[x]] = "\"" + new_val_from_user + "\"";
                        } 
                    }
                }else{ 
                    arg_vals[args[x]] = new_val_from_user;    
                }
            }else{
                /* Get the current val of this arg if it exists */
                cur_val = gup(args[x]);
                if(cur_val != ""){
                    /* The old url had this arg set already, so keep it */
                    arg_vals[args[x]] = cur_val;  
                }
            }
        }

        /* Now create the url */
        var path = window.location.pathname;
        var protocol = window.location.protocol;
        var host = window.location.host;
        var url = protocol + "//" + host + path + "?";   

        for( x in arg_vals){
            url = url + x + "=" + arg_vals[x] + "&"; 
        }
        return url;
    }
    function isValidDate(input){
        var validformat=/^\d{8}$/
        var result = true;
        if (!validformat.test(input)){
            result = false;
        }
        return result;
    }
    function datePickersAreValid(){
        var result = true;
        var start_date = Number($('.start_key_date_picker').val());
        var end_date = Number($('.end_key_datepicker').val());
        if(start_date <= end_date){
            result = false;
            alert("The start date must come before the end date!");
        }
        return result;
    }
    function updateGuiBasedOnUrlArgs(){
        /* This is and ugly hack that I need to revist later. */
        var selected_class = 'ui_selected'; /* Class to add to UI elements that are selected */
        /* Get all current supported args */
        var arg_vals = [];
        for(x in args){
           arg_vals[args[x]] = gup(args[x]); 
        }
        /* Arg-specific logic  */
        if(arg_vals['limit'] != ""){
            $('.limit_options > a').each(function(i, val){
                if($(this).attr('href') == arg_vals['limit'] ){
                    $(this).addClass(selected_class);
                }
            });
        }
        if(arg_vals['descending'] != ""){
            if(arg_vals['descending'] == "False"){
               $('.ascending').addClass(selected_class); 
            }else {
               $('.descending').addClass(selected_class); 
            }
        }
        if(arg_vals['startkey'] != ""){
            $('.start_key_datepicker').val(arg_vals['startkey']);
        }
        if(arg_vals['endkey'] != ""){
            $('.end_key_datepicker').val(arg_vals['endkey']);
        }
    }


    $(document).ready(function(){
        updateGuiBasedOnUrlArgs(); /* This must be first! */
        $.ajax({
            url: '{{ accumLogVolumePath }}',
            success: function(data) {
                var x = JSON.parse(data);
                accum_bytes = x["rows"][0].value;
                accum_GB = accum_bytes / 1073741824;
                accum_GB_rounded = Math.round(accum_GB*100)/100
                $('.accum-log-volume').html("Total Size of Logs: " + accum_GB_rounded + " GB");
            }
        });
        $('.singledatekey_datepicker').datepicker({ 
            dateFormat: 'yymmdd',
            onClose: function(dateText, inst){
                if(isValidDate(dateText) && datePickersAreValid() ){
                    var keys = '{"keys":[{"date":"20101220"}]}';
                    $.ajax({
                       type: "POST",
                       url: window.location,
                       data: keys,
                       success: function(msg){
                           alert( "Data Saved: " + msg );
                       }
                    });
                }
            }
        });
        
        $('.start_key_datepicker').datepicker({ 
            dateFormat: 'yymmdd',
            onClose: function(dateText, inst){
                if(isValidDate(dateText) && datePickersAreValid() ){
                    window.location = new_setup_couchdb_url('startkey', dateText);
                }
            }
        });
        $('.end_key_datepicker').datepicker({ 
            dateFormat: 'yymmdd', 
            onClose: function(dateText, inst){
                if(isValidDate(dateText) && datePickersAreValid() ){
                    window.location = new_setup_couchdb_url('endkey', dateText);
                }
            }
        });
        $('.key_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('key', $(this).attr('href'));
        });
        $('.limit_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('limit', $(this).attr('href'));
        });
        $('.descending_change').live('click', function(e) {
            e.preventDefault();
            window.location = new_setup_couchdb_url('descending', $(this).attr('href'));
        });
        $('.clear_start_key').live('click', function(e) {
            e.preventDefault();
            $('.start_key_datepicker').val('');
            window.location = new_setup_couchdb_url('startkey', '');
        });
        $('.clear_end_key').live('click', function(e) {
            e.preventDefault();
            $('.end_key_datepicker').val('');
            window.location = new_setup_couchdb_url('endkey', '');
        });
        $('.skip_change').live('click', function(e) {
            e.preventDefault();
            var operation = $(this).attr('href');
            var cur_skip = gup('skip');
            var cur_view_limit = gup('limit');
            var new_skip = 0;
            var big_skip = 2;

            if(cur_skip == ""){
                cur_skip = 0;
            }else{
                cur_skip = Number(cur_skip);
            }
            if(cur_view_limit == ""){
                cur_view_limit = 0;
            }else{
                cur_view_limit = Number(cur_view_limit);
            }

            if(cur_view_limit == 0){
                cur_view_limit = 25; /* Min view limit of 25 */
            }
            
            switch(operation){
                case "big_back":
                    new_skip = cur_skip - ( big_skip * cur_view_limit);
                    break;
                case "back":
                    new_skip = cur_skip - cur_view_limit;
                    break;
                case "forward":
                    new_skip = cur_view_limit + cur_skip;
                    break;
                case "big_forward":
                    new_skip = ( big_skip * cur_view_limit) + cur_skip;
                    break;
                default:
                    alert("Error in switch!");
            }
            new_skip = Math.max(0, new_skip); /* Do no give negative numbers. */
            window.location = new_setup_couchdb_url('skip', new_skip);
        });
    });
</script>
